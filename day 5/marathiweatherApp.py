import streamlit as st
import requests
import os
from dotenv import load_dotenv
from langchain.chat_models import init_chat_model


load_dotenv()


st.set_page_config(page_title="AI Weather Guide", page_icon="ЁЯМжя╕П")
st.title("ЁЯМжя╕П Groq LLM рд╡рд╛рдкрд░реВрди рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рд╣рд╡рд╛рдорд╛рди рдорд╛рд░реНрдЧрджрд░реНрд╢рди")


llm = init_chat_model(
    model="llama-3.3-70b-versatile",
    model_provider="openai",
    base_url="https://api.groq.com/openai/v1",
    api_key=os.getenv("GROQ_API_KEY"),
)

conversation = [
    {
        "role": "system",
        "content": "You are a 60 years experienced Indian weather expert who explains weather in simple, caring Marathi language."
    }
]

city = st.text_input("ЁЯПЩя╕П рд╢рд╣рд░рд╛рдЪреЗ рдирд╛рд╡ рдЯрд╛рдХрд╛:")

field = st.selectbox(
    "ЁЯСд рддреБрдордЪреЗ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рдХреНрд╖реЗрддреНрд░ рдирд┐рд╡рдбрд╛:",
    [
        "рд╢реЗрддрдХрд░реА ЁЯМ╛",
        "рд╡рд┐рджреНрдпрд╛рд░реНрдереА ЁЯОУ",
        "рд╢рд┐рдХреНрд╖рдХ ЁЯУЪ",
        "рдбреЙрдХреНрдЯрд░ ЁЯСитАНтЪХя╕П",
        "рдирд░реНрд╕ ЁЯСйтАНтЪХя╕П",
        "IT / Software Engineer ЁЯТ╗",
        "рдСрдлрд┐рд╕ рдХрд░реНрдордЪрд╛рд░реА ЁЯзСтАНЁЯТ╝",
        "рд╡реНрдпрд╛рдкрд╛рд░реА ЁЯПк",
        "рдмрд╛рдВрдзрдХрд╛рдо рдХрд╛рдордЧрд╛рд░ ЁЯС╖",
        "рдбрд┐рд▓рд┐рд╡реНрд╣рд░реА рдмреЙрдп ЁЯЫ╡",
        "рд╕реБрд░рдХреНрд╖рд╛ рд░рдХреНрд╖рдХ ЁЯЫбя╕П",
        "рдбреНрд░рд╛рдпрд╡реНрд╣рд░ ЁЯЪХ",
        "рдкреНрд░рд╡рд╛рд╕реА ЁЯЪЧ",
        "рдЧреГрд╣рд┐рдгреА ЁЯПа",
        "рдШрд░рдЧреБрддреА рдХрд╛рдордЧрд╛рд░ ЁЯз╣",
        "рд╡реГрджреНрдз рд╡реНрдпрдХреНрддреА ЁЯС╡",
        "рд▓рд╣рд╛рди рдореБрд▓реЗ ЁЯС╢",
        "рдЦреЗрд│рд╛рдбреВ ЁЯПГ",
        "рдкреЛрд▓реАрд╕ / рдлрд╛рдпрд░ рдлрд╛рдпрдЯрд░ ЁЯЪУ",
        "рдордЪреНрдЫреАрдорд╛рд░ ЁЯОг",
        "рд╕рд░реНрд╡рд╕рд╛рдорд╛рдиреНрдп рдирд╛рдЧрд░рд┐рдХ ЁЯЩВ"
    ]
)


if city:
    weather_api_key = os.getenv("WEATHER_API_KEY")

    if not weather_api_key:
        st.error("тЭМ WEATHER_API_KEY .env рдлрд╛рдЗрд▓рдордзреНрдпреЗ рд╕рд╛рдкрдбрд▓реА рдирд╛рд╣реА")
    else:
        url = (
            "https://api.openweathermap.org/data/2.5/weather"
            f"?q={city}&appid={weather_api_key}&units=metric"
        )

        response = requests.get(url)

        if response.status_code != 200:
            st.error("тЭМ рд╢рд╣рд░ рд╕рд╛рдкрдбрд▓реЗ рдирд╛рд╣реА рдХрд┐рдВрд╡рд╛ Weather API Error")
        else:
            data = response.json()

            temp = data["main"]["temp"]
            feels = data["main"]["feels_like"]
            humidity = data["main"]["humidity"]
            condition = data["weather"][0]["description"]

          
            st.subheader("ЁЯМН рд╕рдзреНрдпрд╛рдЪреЗ рд╣рд╡рд╛рдорд╛рди")
            st.write(f"ЁЯМбя╕П рддрд╛рдкрдорд╛рди: {temp}┬░C")
            st.write(f"ЁЯдЧ рдЕрдиреБрднрд╡рд▓реЗрд▓реЗ рддрд╛рдкрдорд╛рди: {feels}┬░C")
            st.write(f"ЁЯТз рдЖрд░реНрджреНрд░рддрд╛: {humidity}%")
            st.write(f"ЁЯМея╕П рд╣рд╡рд╛рдорд╛рди рд╕реНрдерд┐рддреА: {condition}")

            
            llm_input = f"""
            рд╡рд░реНрддрдорд╛рди рд╣рд╡рд╛рдорд╛рди рдорд╛рд╣рд┐рддреА:

            рд╢рд╣рд░: {city}
            рддрд╛рдкрдорд╛рди: {temp}┬░C
            рдЕрдиреБрднрд╡рд▓реЗрд▓реЗ рддрд╛рдкрдорд╛рди: {feels}┬░C
            рд╣рд╡рд╛рдорд╛рди рд╕реНрдерд┐рддреА: {condition}
            рдЖрд░реНрджреНрд░рддрд╛: {humidity}%

            рд╡рд╛рдкрд░рдХрд░реНрддреНрдпрд╛рдЪреЗ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рдХреНрд╖реЗрддреНрд░: {field}

            рддреБрдореНрд╣реА ремреж рд╡рд░реНрд╖рд╛рдВрдЪрд╛ рдЕрдиреБрднрд╡ рдЕрд╕рд▓реЗрд▓реЗ рд╣рд╡рд╛рдорд╛рди рддрдЬреНрдЬреНрдЮ рдЖрд╣рд╛рдд. ЁЯШО
            рд╡рд░реАрд▓ рд╣рд╡рд╛рдорд╛рди рдкрд╛рд╣реВрди **{field} рдпрд╛ рдХреНрд╖реЗрддреНрд░рд╛рд╕рд╛рдареА рдЦрд╛рд╕ рдЖрдгрд┐ рдЙрдкрдпреБрдХреНрдд рд╕рд▓реНрд▓рд╛** рджреНрдпрд╛.

            рд╕реВрдЪрдирд╛:
            - рдЙрддреНрддрд░ рдлрдХреНрдд 3тАУ5 рд╡рд╛рдХреНрдпрд╛рдВрдд рджреНрдпрд╛
            - рддреНрдпрд╛ рдХреНрд╖реЗрддреНрд░рд╛рд╢реА рдереЗрдЯ рд╕рдВрдмрдВрдзрд┐рдд рдорд╛рд░реНрдЧрджрд░реНрд╢рди рджреНрдпрд╛
            - рдЖрд░реЛрдЧреНрдп, рд╕реБрд░рдХреНрд╖рд┐рддрддрд╛ рдЖрдгрд┐ рдХрд╛рдорд╛рд╡рд░ рд╣реЛрдгрд╛рд░рд╛ рдкрд░рд┐рдгрд╛рдо рд╕рд╛рдВрдЧрд╛
            - рднрд╛рд╖рд╛ рдЕрддрд┐рд╢рдп рд╕реЛрдкреА, рдХрд╛рд│рдЬреА рдШреЗрдгрд╛рд░реА рдЖрдгрд┐ рдордЬреЗрд╢реАрд░ рдареЗрд╡рд╛ ЁЯШД
            - рдпреЛрдЧреНрдп emoji рд╡рд╛рдкрд░рд╛ ЁЯМжя╕ПЁЯМбя╕ПтШВя╕ПЁЯедЁЯМ╛
            - рдЙрддреНрддрд░ рдлрдХреНрдд рдорд░рд╛рдареАрдд рджреНрдпрд╛
            """

            conversation.append({"role": "user", "content": llm_input})

            with st.spinner("ЁЯдЦ AI рд╣рд╡рд╛рдорд╛рди рддрдЬреНрдЬреНрдЮ рдорд╛рд░реНрдЧрджрд░реНрд╢рди рджреЗрдд рдЖрд╣реЗ..."):
                result = llm.invoke(conversation)

            
            st.subheader("ЁЯза AI рдЖрдзрд╛рд░рд┐рдд рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рд╣рд╡рд╛рдорд╛рди рд╕рд▓реНрд▓рд╛")
            st.success(result.content)
